{% extends "base.html" %}
{% load static %}

{% block title %}Agenda - {{ tarea.nombre_tarea }}{% endblock title %}

{% block extra_css %}
<link href="{% static 'css/detalleTarea.css' %}" rel="stylesheet">
{% endblock %}

{% block content %}
<div class="hero-section">
    <!-- Encabezado fijo a la izquierda superior -->
    <h2 class="section-title">
        <a href="{% url 'miapp:listar_tareas' %}" class="back-arrow" title="Volver a tareas">
            <i class="bi bi-arrow-left"></i>
        </a>
        Detalles de Tarea
    </h2>

    <!-- Título y badge -->
    <div class="titulo-tarea-container mt-4 mb-4">
        <div class="container">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="mb-0">{{ tarea.nombre_tarea }}</h1>
                </div>
                <div class="badge-estado">
                    {% if tarea.estatus.nombre == "nue" %}
                    <span class="badge bg-new">NUEVO</span>
                    {% elif tarea.estatus.nombre == "pro" %}
                    <span class="badge bg-progress">EN PROGRESO</span>
                    {% elif tarea.estatus.nombre == "fin" %}
                    <span class="badge bg-success">COMPLETADA</span>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <div class="contenedor-detalles">
        <!-- Panel izquierdo: Contenido principal -->
        <div class="info-principal">
            <!-- Tarjeta de información general -->
            <div class="card mb-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0">Información General</h5>
                </div>
                <div class="card-body">
                    <div class="row g-3 align-items-center">
                        <!-- Asignatura -->
                        <div class="col-md-3">
                            <div class="d-flex flex-column align-items-center text-center">
                                <div class="me-2">
                                    <i class="bi bi-book text-muted"></i>
                                </div>
                                <div>
                                    <h6 class="text-muted mb-1">Asignatura</h6>
                                    <p class="fs-5 mb-0">{{ tarea.asignatura }}</p>
                                </div>
                            </div>
                        </div>

                        <!-- Modalidad -->
                        <div class="col-md-3">
                            <div class="d-flex flex-column align-items-center text-center">
                                <div class="me-2">
                                    <i class="bi bi-people text-muted"></i>
                                </div>
                                <div>
                                    <h6 class="text-muted mb-1">Modalidad</h6>
                                    <p class="fs-5 mb-0">
                                        {% if tarea.modalidad == "ind" %}
                                        <span class="badge bg-primary">Individual</span>
                                        {% else %}
                                        <span class="badge bg-secondary">En Equipo</span>
                                        {% endif %}
                                    </p>
                                </div>
                            </div>
                        </div>

                        <!-- Fecha Entrega -->
                        <div class="col-md-3">
                            <div class="d-flex flex-column align-items-center text-center">
                                <div class="me-2">
                                    <i class="bi bi-calendar-check text-muted"></i>
                                </div>
                                <div>
                                    <h6 class="text-muted mb-1">Fecha Entrega</h6>
                                    <p class="fs-5 mb-0">{{ tarea.fecha_entrega|date:"d/m/Y" }}</p>
                                </div>
                            </div>
                        </div>

                        <!-- Estado Actual -->
                        <div class="col-md-3">
                            <div class="d-flex flex-column align-items-center text-center">
                                <div class="me-2">
                                    <i class="bi bi-flag text-muted"></i>
                                </div>
                                <div>
                                    <h6 class="text-muted mb-1">Estado</h6>
                                    <p class="fs-5 mb-0">
                                        {% if tarea.estatus.nombre == "nue" %}
                                        <span class="badge bg-new">Nuevo</span>
                                        {% elif tarea.estatus.nombre == "pro" %}
                                        <span class="badge bg-progress">En Progreso</span>
                                        {% elif tarea.estatus.nombre == "fin" %}
                                        <span class="badge bg-success">Completado</span>
                                        {% endif %}
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tarjeta de descripcion -->
            <div class="card mb-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0">Descripción</h5>
                </div>
                <div class="card-body">
                    {% if tarea.descripcion_tarea %}
                    <div class="descripcion-contenido">
                        {{ tarea.descripcion_tarea|linebreaks }}
                    </div>
                    {% else %}
                    <p class="text-muted fst-italic">No hay descripción proporcionada para esta tarea.</p>
                    {% endif %}
                </div>
            </div>

            <!-- Tarjeta de notas -->
            <div class="card mb-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0">
                       </i>Notas
                </div>
                <div class="card-body">
                    {% if tarea.comentarios.all %}
                    <div class="contenedor-postit">
                        {% for comentario in tarea.comentarios.all %}
                        <div class="postit">
                            <div class="postit-header">
                                <small class="text-muted">
                                    <i class="bi bi-clock me-1"></i>{{ comentario.fecha_creacion|date:"d/m/Y H:i" }}
                                </small>
                            </div>
                            <div class="postit-body">
                                <p>{{ comentario.contenido|linebreaksbr }}</p>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <i class="bi bi-chat-left display-1 text-muted"></i>
                        <h5 class="text-muted mt-3">Sin notas</h5>
                    </div>
                    {% endif %}
                </div>
            </div>

        </div>

        <!-- Panel derecho: Acciones rápidas -->
        <div class="panel-acciones">
            <div class="card">
                <div class="card-header bg-light">
                    <h5 class="mb-0">Acciones Rápidas</h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        {% if tarea.estatus.nombre != "fin" %}
                        <button type="button" class="btn btn-success btn-lg" data-bs-toggle="modal"
                            data-bs-target="#modalCambiarEstado">
                            Marcar como Completada
                        </button>
                        {% endif %}

                        <button type="button" class="btn btn-primary btn-lg" data-bs-toggle="modal"
                            data-bs-target="#modalReprogramar">
                            Reprogramar Tarea
                        </button>

                        <button type="button" class="btn btn-outline-danger btn-lg" data-bs-toggle="modal"
                            data-bs-target="#modalEliminar">
                            Eliminar Tarea
                        </button>

                        <a href="{% url 'miapp:listar_tareas' %}" class="btn btn-outline-secondary">
                            Volver a la Lista
                        </a>
                    </div>

                    <!-- Información adicional -->
                    <div class="mt-4 pt-3 border-top">
                        <h6 class="text-muted mb-3">Información Adicional</h6>
                        <ul class="list-unstyled">
                            <li class="mb-2 d-flex align-items-center">
                                <i class="bi bi-calendar-x me-2 icon-dias"></i>
                                <div>
                                    <strong>Días restantes:</strong> {{ tarea.dias_restantes_texto }}
                                </div>
                            </li>
                            <li class="mb-2 d-flex align-items-center">
                                <i class="bi bi-star me-2 icon-prioridad"></i>
                                <div>
                                    <strong>Prioridad:</strong>
                                    {% if tarea.prioridad == "alt" %}
                                        <span class="prioridad-alta">Alta</span>
                                    {% elif tarea.prioridad == "med" %}
                                        <span class="prioridad-media">Media</span>
                                    {% else %}
                                        <span class="prioridad-baja">Baja</span>
                                    {% endif %}
                                </div>
                            </li>
                            <li class="d-flex align-items-center">
                                <i class="bi bi-person me-2 icon-creador"></i>
                                <div>
                                    <strong>Creada por:</strong> {{ tarea.usuario.nombre_completo }}
                                </div>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Reprogramar Tarea -->
<div class="modal fade" id="modalReprogramar" tabindex="-1" aria-labelledby="modalReprogramarLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <form method="POST" action="{% url 'miapp:editar_tarea' tarea.id %}">
                {% csrf_token %}
                <div class="modal-header">
                    <h5 class="modal-title" id="modalReprogramarLabel">
                        Reprogramar Tarea
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    
                    <div class="mb-3">
                        <label for="fechaActual" class="form-label">Fecha de entrega actual</label>
                        <input type="text" class="form-control" id="fechaActual" 
                               value="{{ tarea.fecha_entrega|date:'d/m/Y' }}" readonly style="background-color: #f8f9fa;">
                    </div>
                    
                    <div class="mb-3">
                        <label for="nuevaFecha" class="form-label">
                            <strong>Nueva fecha de entrega</strong>
                        </label>
                        <input type="date" class="form-control" id="nuevaFecha" name="fecha_entrega" 
                               min="{% now 'Y-m-d' %}" required>
                        <small class="form-text text-muted">Selecciona la nueva fecha límite</small>
                    </div>
                    
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i>
                        <small>Solo se actualizará la fecha de entrega. El resto de la información permanecerá igual.</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">
                        Reprogramar
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal para Cambiar Estado -->
<div class="modal fade" id="modalCambiarEstado" tabindex="-1" aria-labelledby="modalCambiarEstadoLabel"
    aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" action="{% url 'miapp:actualizar_estado' tarea.id %}">
                {% csrf_token %}
                <div class="modal-header">
                    <h5 class="modal-title" id="modalCambiarEstadoLabel">
                        Cambiar Estado de Tarea
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="nuevoEstado" class="form-label">Seleccionar Nuevo Estado</label>
                        <select class="form-select" id="nuevoEstado" name="estado" required>
                            <option value="nue">Nuevo</option>
                            <option value="pro">En Progreso</option>
                            <option value="fin">Completado</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="comentarioEstado" class="form-label">Comentario (opcional)</label>
                        <textarea class="form-control" id="comentarioEstado" name="comentario" rows="3"
                            placeholder="Agrega un comentario sobre el cambio de estado..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-success">Actualizar Estado</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal para Eliminar -->
<div class="modal fade" id="modalEliminar" tabindex="-1" aria-labelledby="modalEliminarLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 id="modalEliminarLabel">
                    Confirmar Eliminación
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="text-center">¿Estás seguro de que deseas eliminar esta tarea?</p>
                <div class="alert alert-warning">
                    <h2 class="text-center" class="alert-heading">"{{ tarea.nombre_tarea }}"</h2>
                    <p class="text-center" class="alert-heading">"{{ tarea.asignatura }}"</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <form method="POST" action="{% url 'miapp:eliminar_tarea' tarea.id %}" class="d-inline">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger">Eliminar</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    // Script al scrollear se oculta el header
    let lastScrollY = window.scrollY;
    const sectionTitle = document.querySelector('.section-title');
    let ticking = false;

    function updateHeader() {
        if (window.scrollY > lastScrollY && window.scrollY > 100) {
            sectionTitle.classList.add('hidden');
        } else {
            sectionTitle.classList.remove('hidden');
        }
        lastScrollY = window.scrollY;
        ticking = false;
    }

    function onScroll() {
        if (!ticking) {
            requestAnimationFrame(updateHeader);
            ticking = true;
        }
    }

    window.addEventListener('scroll', onScroll, { passive: true });

    // Mostrar header al hacer hover cerca del top
    document.addEventListener('mousemove', (e) => {
        if (e.clientY < 100 && sectionTitle.classList.contains('hidden')) {
            sectionTitle.classList.remove('hidden');
        }
    });

    // Cambiar texto del botón según estado seleccionado
    document.addEventListener('DOMContentLoaded', function () {
        const estadoSelect = document.getElementById('nuevoEstado');
        const btnCompletar = document.querySelector('.btn-success.btn-lg');

        if (estadoSelect && btnCompletar) {
            estadoSelect.addEventListener('change', function () {
                if (this.value === 'fin') {
                    btnCompletar.innerHTML = 'Marcar como Completada';
                } else if (this.value === 'pro') {
                    btnCompletar.innerHTML = 'En Progreso';
                } else {
                    btnCompletar.innerHTML = 'Marcar como Nuevo';
                }
            });
        }

        // Configurar fecha mínima para reprogramación
        const nuevaFechaInput = document.getElementById('nuevaFecha');
        if (nuevaFechaInput) {
            const today = new Date();
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);
            const tomorrowStr = tomorrow.toISOString().split('T')[0];
            
            nuevaFechaInput.min = tomorrowStr;
            
            const sugerida = new Date(today);
            sugerida.setDate(sugerida.getDate() + 3);
            const sugeridaStr = sugerida.toISOString().split('T')[0];
            nuevaFechaInput.value = sugeridaStr;
        }
    });
    
</script>
{% endblock %}