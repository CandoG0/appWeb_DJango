{% extends "base.html" %}
{% load static %}

{% block title %}Agenda - Calendario{% endblock title %}

{% block extra_css %}
<link href="{% static 'css/calendario.css' %}" rel="stylesheet">
<link href='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css' rel='stylesheet' />
{% endblock %}

{% block content %}
<div class="hero-section">
    <!-- Encabezado fijo a la izquierda superior -->
    <h2 class="section-title">
        <a href="javascript:history.back()" class="back-arrow" title="Regresar">
            <i class="bi bi-arrow-left"></i>
        </a>
        Calendario
    </h2>

    <!-- Controles del mes -->
    <div class="calendar-header">
        <button class="nav-btn" id="prevMonth" title="Mes anterior">
            <i class="bi bi-chevron-left"></i>
        </button>

        <h3 class="month-title" id="monthTitle">Cargando...</h3>

        <button class="nav-btn" id="nextMonth" title="Mes siguiente">
            <i class="bi bi-chevron-right"></i>
        </button>
    </div>

    <!-- Calendario -->
    <div id="calendar"></div>
</div>

<!-- Modal para ver información detallada de una tarea -->
<div class="modal fade" id="modalTareaDetalle" tabindex="-1" aria-labelledby="modalTareaDetalleLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTareaDetalleLabel">
                    <i class="bi bi-card-checklist me-2"></i>
                    Detalle de Tarea
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Título de la tarea -->
                <h5 id="tareaTitulo" class="mb-4 text-center" style="color: #374375;"></h5>

                <div class="tarea-info-simple">
                    <div class="info-item-simple mb-3">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-book me-3" style="color: #374375; min-width: 24px;"></i>
                            <div>
                                <div class="text-muted small">Materia</div>
                                <div id="tareaAsignatura" class="fw-bold"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="info-item-simple mb-3">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-calendar-event me-3" style="color: #374375; min-width: 24px;"></i>
                            <div>
                                <div class="text-muted small">Fecha de Entrega</div>
                                <div id="tareaFecha" class="fw-bold"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="info-item-simple mb-3">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-people me-3" style="color: #374375; min-width: 24px;"></i>
                            <div>
                                <div class="text-muted small">Modalidad</div>
                                <div id="tareaModalidad" class="fw-bold"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="info-item-simple mb-3">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-flag me-3" style="color: #374375; min-width: 24px;"></i>
                            <div>
                                <div class="text-muted small">Estado</div>
                                <div id="tareaEstado" class="fw-bold"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x me-1"></i> Cerrar
                </button>
                <a href="#" id="tareaVerLink" class="btn btn-primary">
                    <i class="bi bi-eye me-1"></i> Ver Tarea
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Scripts de FullCalendar -->
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js'></script>
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/locales/es.js'></script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const calendarEl = document.getElementById('calendar');
        
        // Inicializar calendario
        const calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            locale: 'es',
            headerToolbar: {
                left: '',
                center: '',
                right: ''
            },
            events: function(fetchInfo, successCallback, failureCallback) {
                // Cargar tareas desde la API
                fetch('{% url "miapp:tareas_calendario_api" %}')
                    .then(response => response.json())
                    .then(data => {
                        successCallback(data);
                    })
                    .catch(error => {
                        console.error('Error cargando tareas:', error);
                        failureCallback(error);
                    });
            },
            eventClick: function(info) {
                // Mostrar modal con detalles de la tarea específica
                mostrarDetalleTarea(info.event);
            },
        }); 

        calendar.render();

        // Función para mostrar detalles de una tarea
        function mostrarDetalleTarea(tarea) {
            // Título
            document.getElementById('tareaTitulo').textContent = tarea.title;
            
            // Información básica
            document.getElementById('tareaAsignatura').textContent = tarea.extendedProps.asignatura;
            
            // Fecha formateada
            const fecha = new Date(tarea.start);
            document.getElementById('tareaFecha').textContent = fecha.toLocaleDateString('es-ES', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            
            document.getElementById('tareaModalidad').textContent = tarea.extendedProps.modalidad;
            
            // Estado
            const estado = tarea.extendedProps.estado || 'nue';
            let estadoDisplay = tarea.extendedProps.estado_display || 'Nuevo';
            
            // Convertir estado a formato legible
            if (estado === 'nue') estadoDisplay = 'Nuevo';
            else if (estado === 'pro') estadoDisplay = 'En progreso';
            else if (estado === 'fin') estadoDisplay = 'Completado';
            
            document.getElementById('tareaEstado').textContent = estadoDisplay;
            
            document.getElementById('tareaVerLink').href = `/miapp/tareas/detalle/${tarea.id}/`;
            
            // Mostrar modal
            const modal = new bootstrap.Modal(document.getElementById('modalTareaDetalle'));
            modal.show();
        }

        // Actualizar título del mes
        function updateMonthTitle() {
            const currentDate = calendar.getDate();
            const monthTitle = currentDate.toLocaleDateString('es-ES', {
                month: 'long',
                year: 'numeric'
            });
            document.getElementById('monthTitle').textContent =
                monthTitle.charAt(0).toUpperCase() + monthTitle.slice(1);
        }

        updateMonthTitle();

        // Navegación entre meses
        document.getElementById('prevMonth').addEventListener('click', function () {
            calendar.prev();
            updateMonthTitle();
        });

        document.getElementById('nextMonth').addEventListener('click', function () {
            calendar.next();
            updateMonthTitle();
        });

        // Ocultar header
        let lastScrollY = window.scrollY;
        const sectionTitle = document.querySelector('.section-title');
        let ticking = false;

        function updateHeader() {
            if (window.scrollY > lastScrollY && window.scrollY > 100) {
                sectionTitle.classList.add('hidden');
            } else {
                sectionTitle.classList.remove('hidden');
            }
            lastScrollY = window.scrollY;
            ticking = false;
        }

        function onScroll() {
            if (!ticking) {
                requestAnimationFrame(updateHeader);
                ticking = true;
            }
        }

        window.addEventListener('scroll', onScroll, { passive: true });

        document.addEventListener('mousemove', (e) => {
            if (e.clientY < 100 && sectionTitle.classList.contains('hidden')) {
                sectionTitle.classList.remove('hidden');
            }
        });

        // Inicializar tooltips de Bootstrap
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });
    });
</script>

{% endblock %}